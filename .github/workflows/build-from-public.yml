name: Build App (Public Runner)

# This workflow is designed to be copied to a PUBLIC repository
# It checks out a PRIVATE repository using a deploy key and builds the app
# This allows using GitHub's free macOS runners without limits

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - ios-development
          - ios-production
          - android-development
          - android-production
      submit_to_testflight:
        description: 'Submit iOS to TestFlight (only for ios-production)'
        required: false
        default: false
        type: boolean
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major

env:
  PRIVATE_REPO: ${{ secrets.PRIVATE_REPO }}  # e.g., "username/LangTeacherAI"
  # Expo/EAS
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  # RevenueCat
  EXPO_PUBLIC_REVENUECAT_IOS_KEY: ${{ secrets.EXPO_PUBLIC_REVENUECAT_IOS_KEY }}
  EXPO_PUBLIC_REVENUECAT_ANDROID_KEY: ${{ secrets.EXPO_PUBLIC_REVENUECAT_ANDROID_KEY }}
  # Other env vars
  EXPO_PUBLIC_PPT_KEY: ${{ secrets.EXPO_PUBLIC_PPT_KEY }}
  EXPO_PUBLIC_FUNCTION_SERVICES_ENABLER: ${{ secrets.EXPO_PUBLIC_FUNCTION_SERVICES_ENABLER }}
  EXPO_PUBLIC_FUNCTION_ADD_SUBSCRIPTION_CREDITS_BY_ENTITLEMENT: ${{ secrets.EXPO_PUBLIC_FUNCTION_ADD_SUBSCRIPTION_CREDITS_BY_ENTITLEMENT }}
  # Apple credentials (for TestFlight)
  APPLE_ID: ${{ secrets.APPLE_ID }}
  APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
  # Debug token (for development builds)
  EXPO_PUBLIC_FIREBASE_APP_CHECK_DEBUG_TOKEN: ${{ secrets.EXPO_PUBLIC_FIREBASE_APP_CHECK_DEBUG_TOKEN }}

jobs:
  build-ios:
    if: startsWith(github.event.inputs.platform, 'ios')
    runs-on: macos-14
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRIVATE_REPO }}
          ssh-key: ${{ secrets.PRIVATE_REPO_DEPLOY_KEY }}
          ref: main

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: npm

      - name: Install dependencies
        run: npm ci

      - name: Run postinstall patches
        run: npm run postinstall

      - name: Version bump (if requested)
        if: github.event.inputs.version_bump != 'none'
        run: |
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          echo "Version bumped to $(node -p "require('./package.json').version")"

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event.inputs.platform }}" == "ios-production" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
            echo "output_name=build-rakulingo-release.ipa" >> $GITHUB_OUTPUT
            echo "artifact_name=rakulingo-ios-production" >> $GITHUB_OUTPUT
          else
            echo "profile=development" >> $GITHUB_OUTPUT
            echo "output_name=build-rakulingo-dev.ipa" >> $GITHUB_OUTPUT
            echo "artifact_name=rakulingo-ios-development" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS app
        run: |
          eas build --platform ios \
            --profile ${{ steps.profile.outputs.profile }} \
            --local \
            --non-interactive \
            --output ${{ github.workspace }}/${{ steps.profile.outputs.output_name }}

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.profile.outputs.artifact_name }}
          path: ${{ github.workspace }}/${{ steps.profile.outputs.output_name }}
          retention-days: 7

      - name: Upload to TestFlight
        if: github.event.inputs.platform == 'ios-production' && github.event.inputs.submit_to_testflight == 'true'
        run: |
          echo "Uploading to TestFlight..."
          xcrun altool --upload-app \
            -f ${{ github.workspace }}/${{ steps.profile.outputs.output_name }} \
            -t ios \
            -u "${{ env.APPLE_ID }}" \
            -p "${{ env.APPLE_APP_SPECIFIC_PASSWORD }}"

  build-android:
    if: startsWith(github.event.inputs.platform, 'android')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRIVATE_REPO }}
          ssh-key: ${{ secrets.PRIVATE_REPO_DEPLOY_KEY }}
          ref: main

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Increase Gradle memory
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: npm

      - name: Install dependencies
        run: npm ci

      - name: Run postinstall patches
        run: npm run postinstall

      - name: Version bump (if requested)
        if: github.event.inputs.version_bump != 'none'
        run: |
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          echo "Version bumped to $(node -p "require('./package.json').version")"
          node -e "
          const fs = require('fs');
          const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
          appJson.expo.android.versionCode = (appJson.expo.android.versionCode || 0) + 1;
          fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2));
          console.log('Android versionCode updated to', appJson.expo.android.versionCode);
          "

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event.inputs.platform }}" == "android-production" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
            echo "output_name=build-rakulingo-release.aab" >> $GITHUB_OUTPUT
            echo "artifact_name=rakulingo-android-production" >> $GITHUB_OUTPUT
          else
            echo "profile=development" >> $GITHUB_OUTPUT
            echo "output_name=build-rakulingo-dev.apk" >> $GITHUB_OUTPUT
            echo "artifact_name=rakulingo-android-development" >> $GITHUB_OUTPUT
          fi

      - name: Build Android app
        run: |
          eas build --platform android \
            --profile ${{ steps.profile.outputs.profile }} \
            --local \
            --non-interactive \
            --output ${{ github.workspace }}/${{ steps.profile.outputs.output_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.profile.outputs.artifact_name }}
          path: ${{ github.workspace }}/${{ steps.profile.outputs.output_name }}
          retention-days: 7
